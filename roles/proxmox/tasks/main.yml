---
#################################
# repos, packages, admin user
#################################
- ansible.builtin.import_tasks: roles/proxmox/tasks/nodes/enterprise_repos.yml
- ansible.builtin.import_tasks: roles/proxmox/tasks/nodes/required_packages.yml
- ansible.builtin.import_tasks: roles/proxmox/tasks/nodes/admin_user.yml

- name: Get all existing containers
  block:
    - name: List all existing virtual machines on node of type lxc
      community.proxmox.proxmox_vm_info:
        api_host: "{{ proxmox_node_ip }}"
        api_user: "{{ proxmox_admin_api_user }}"
        api_password: "{{ proxmox_admin_password }}"
        type: lxc
      register: container_list
    - name: Set container list to be used in other plays
      ansible.builtin.set_fact:
        proxmox_containers: "{{ container_list }}"

#################################
# API authentication
#################################
- name: Request auth ticket
  ansible.builtin.uri:
    url: "https://{{ proxmox_node_ip }}:8006/api2/json/access/ticket"
    method: POST
    validate_certs: no
    body_format: json
    body:
      {
        "username": "{{ proxmox_admin_api_user }}",
        "password": "{{ proxmox_admin_password }}",
      }
  register: ticket_response

#################################
# Node configuration
#################################
- ansible.builtin.import_tasks: roles/proxmox/tasks/nodes/templates.yml
- ansible.builtin.import_tasks: roles/proxmox/tasks/nodes/network.yml
- ansible.builtin.import_tasks: roles/proxmox/tasks/nodes/storage.yml

#################################
# Service accounts
#################################
- ansible.builtin.import_tasks: roles/proxmox/tasks/service_users/homeassistant.yml
- ansible.builtin.import_tasks: roles/proxmox/tasks/service_users/homepage.yml

#################################
# Create containers
#################################
- name: Create container templates
  ansible.builtin.include_tasks:
    file: "roles/proxmox/tasks/containers/templates/{{ hostname }}.yml"
  loop:
    - { name: debian12_template, vmid: 999 }
  vars:
    hostname: "{{ item.name }}"
    sanitized_hostname: "{{ item.name | replace('_', '-') }}"
    vmid: "{{ item.vmid }}"
# - name: Create Debian 12 container clones
#   ansible.builtin.include_tasks:
#     file: "roles/proxmox/tasks/containers/debian12_clone.yml"
#   loop:
#     - centaurus
#   vars:
#     hostname: "{{ item }}"
